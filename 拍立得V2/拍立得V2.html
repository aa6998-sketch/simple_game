<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Mint Cam Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;500;700&family=Caveat:wght@400;700&display=swap');

        * { box-sizing: border-box; }
        
        body {
            background-color: #f0f4f8;
            background-image: radial-gradient(#dfe6e9 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Roboto', sans-serif;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* === School Badge Animation & Style === */
        @keyframes floating-sway {
            0% { transform: rotate(-5deg) translateY(0px); }
            50% { transform: rotate(3deg) translateY(-8px); }
            100% { transform: rotate(-5deg) translateY(0px); }
        }

        .school-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 100px; /* 調整適合的大小 */
            height: auto;
            z-index: 40; /* 確保在背景之上，但在彈出視窗之下 */
            animation: floating-sway 4s ease-in-out infinite; /* 慢慢晃動的特效 */
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15)); /* 增加一點立體感 */
            pointer-events: auto; /* 修改：允許滑鼠互動 */
            cursor: help; /* 修改：滑鼠游標變更為幫助樣式 */
            transition: opacity 0.3s;
        }

        /* 當螢幕較小時，稍微縮小校徽 */
        @media (max-width: 768px) {
            .school-badge {
                width: 80px;
                top: 15px;
                left: 15px;
            }
        }

        /* === Feature Tooltip Style (新增功能介紹氣泡) === */
        .feature-tooltip {
            position: absolute;
            top: 130px; /* 位於校徽下方 */
            left: 25px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 12px;
            border-bottom-left-radius: 2px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 14px;
            color: #5a8274;
            font-weight: bold;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transform-origin: top left;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            z-index: 100;
            max-width: 200px;
            line-height: 1.5;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .feature-tooltip.active {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* 手機版調整氣泡位置 */
        @media (max-width: 768px) {
            .feature-tooltip {
                top: 100px;
                left: 20px;
                font-size: 13px;
                padding: 10px 14px;
            }
        }

        /* === Camera 3D Design === */
        .camera-body {
            width: 320px;
            height: 340px;
            background: linear-gradient(135deg, #cbf0de 0%, #b2e2cd 50%, #9ad4bd 100%);
            border-radius: 65px;
            position: relative;
            box-shadow: 
                inset 5px 5px 15px rgba(255,255,255,0.8), 
                inset -8px -8px 25px rgba(0,0,0,0.15),   
                25px 35px 60px rgba(0,0,0,0.25),         
                -5px -5px 20px rgba(255,255,255,0.5);    
            z-index: 20;
            transition: transform 0.1s;
            flex-shrink: 0;
        }

        .camera-body:active { transform: scale(0.99); }

        .camera-grip {
            position: absolute;
            left: 0; top: 40px; bottom: 40px;
            width: 55px;
            background: linear-gradient(90deg, rgba(0,0,0,0.08), transparent 80%);
            border-radius: 60px 0 0 60px;
        }

        .flash {
            position: absolute;
            top: 30px; right: 40px;
            width: 44px; height: 64px;
            background: linear-gradient(135deg, #f0f4f2, #d1d9d6);
            border-radius: 14px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 2px 2px 1px rgba(255,255,255,1);
            overflow: hidden;
            z-index: 25;
        }
        
        .flash::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85%; height: 85%;
            background: 
                radial-gradient(circle at center, rgba(255,255,255,0.9) 0%, transparent 60%),
                repeating-linear-gradient(0deg, transparent 0px, transparent 2px, rgba(0,0,0,0.1) 3px),
                repeating-linear-gradient(90deg, transparent 0px, transparent 2px, rgba(0,0,0,0.1) 3px);
            background-color: #eef2f0;
            border-radius: 8px;
        }

        .viewfinder {
            position: absolute;
            top: 45px; right: 105px;
            width: 24px; height: 24px;
            background: radial-gradient(circle at 30% 30%, #555, #111);
            border-radius: 8px;
            box-shadow: inset 1px 1px 3px rgba(255,255,255,0.3);
        }

        .sensor-dots {
            position: absolute;
            top: 52px; right: 145px;
            display: flex;
            gap: 6px;
        }
        .dot {
            width: 10px; height: 10px;
            background: radial-gradient(circle at 30% 30%, #444, #000);
            border-radius: 50%;
        }

        .lens-mount {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -40%);
            width: 230px; height: 230px;
            background: radial-gradient(circle, #cbf0de 40%, #a5dcc5 100%);
            border-radius: 50%;
            box-shadow: -8px -8px 20px rgba(255,255,255,0.7), 8px 8px 25px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 22;
        }

        .lens-ring-outer {
            width: 190px; height: 190px;
            background: linear-gradient(135deg, #b8e6d3, #9adbc0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .lens-text {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            animation: rotateText 20s linear infinite;
            opacity: 0.7;
            pointer-events: none;
            z-index: 2;
        }
        .lens-text path { fill: none; }
        .lens-text text {
            fill: #5a8274;
            font-size: 10px;
            font-family: monospace;
            letter-spacing: 2px;
            font-weight: bold;
        }

        @keyframes rotateText {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .lens-glass {
            width: 96px; height: 96px;
            background: #1a1a1a;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            border: 6px solid #2d2d2d;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.9);
            z-index: 1;
        }

        .lens-glass video, .lens-glass canvas#livePreview {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            position: absolute;
            top: 0; left: 0;
        }

        .lens-glass::before {
            content: '';
            position: absolute;
            top: 15%; left: 15%;
            width: 25px; height: 12px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            transform: rotate(-45deg);
            z-index: 3;
            pointer-events: none;
        }

        .shutter-socket {
            position: absolute;
            top: 105px; left: 28px;
            width: 64px; height: 64px;
            background: linear-gradient(135deg, #aaddc8, #cbf0de);
            border-radius: 50%;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shutter-btn {
            width: 50px; height: 50px;
            background: radial-gradient(circle at 35% 35%, #e0fff4 0%, #a2dcc0 40%, #8bc4aa 100%);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 10px rgba(0,0,0,0.15), inset 2px 2px 5px rgba(255,255,255,1);
            transition: all 0.1s;
            position: relative;
        }

        .shutter-btn:active {
            transform: scale(0.92) translateY(2px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2), inset 3px 3px 8px rgba(0,0,0,0.2);
        }

        .shutter-btn:hover { filter: brightness(1.05); }

        /* Mode indicator on shutter */
        .mode-indicator {
            position: absolute;
            bottom: -25px; left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            color: #5a8274;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        /* === Countdown Overlay === */
        .countdown-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .countdown-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .countdown-number {
            font-size: 150px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 50px rgba(255,255,255,0.5);
            animation: countPulse 1s ease-in-out;
        }
        @keyframes countPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* === Polaroid Film === */
        .polaroid-film {
            position: absolute;
            top: 30px; right: 40px;
            width: 220px; height: 260px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 5;
            display: none;
            transform: rotate(-5deg) scale(0.9);
            pointer-events: none;
            padding: 15px 15px 50px 15px;
        }

        .polaroid-detail {
            position: absolute;
            width: 240px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 30;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: grab;
            background: white;
        }

        .polaroid-detail:hover {
            z-index: 100 !important;
            transform: scale(1.05) rotate(0deg) !important;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .polaroid-image-area {
            width: 100%;
            aspect-ratio: 1;
            background-color: #1a1a1a;
            overflow: hidden;
            position: relative;
        }

        .polaroid-image-area.ratio-4-3 { aspect-ratio: 4/3; }
        .polaroid-image-area.ratio-16-9 { aspect-ratio: 16/9; }

        .polaroid-detail img {
            width: 100%; height: 100%;
            object-fit: cover;
            transition: opacity 3s ease-in-out;
        }

        /* === Frame Styles === */
        .frame-white { background: white; }
        .frame-black { background: #1a1a1a; }
        .frame-mint { background: #d1fae5; }
        .frame-pink { background: #fce7f3; }
        
        /* 聖誕節系列 */
        .frame-christmas { 
            background: linear-gradient(135deg, #dc2626 0%, #16a34a 50%, #dc2626 100%);
        }
        .frame-christmas-gold {
            background: linear-gradient(135deg, #b91c1c 0%, #fbbf24 25%, #16a34a 50%, #fbbf24 75%, #b91c1c 100%);
        }
        .frame-christmas-snow {
            background: linear-gradient(135deg, #e0f2fe 0%, #ffffff 50%, #bae6fd 100%);
            border: 3px solid #7dd3fc;
        }
        .frame-christmas-cozy {
            background: linear-gradient(135deg, #7c2d12 0%, #b45309 50%, #92400e 100%);
        }
        
        /* 新年系列 */
        .frame-newyear {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
            border: 2px solid #fbbf24;
        }
        .frame-newyear-gold {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 25%, #d97706 50%, #f59e0b 75%, #fbbf24 100%);
        }
        .frame-cny {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%);
            border: 3px solid #fbbf24;
        }
        .frame-cny-dragon {
            background: linear-gradient(135deg, #dc2626 0%, #fbbf24 50%, #dc2626 100%);
        }
        
        /* 生日系列 */
        .frame-birthday {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 50%, #06b6d4 100%);
        }
        .frame-birthday-pastel {
            background: linear-gradient(135deg, #fbcfe8 0%, #c4b5fd 50%, #a5f3fc 100%);
        }
        .frame-birthday-neon {
            background: linear-gradient(135deg, #f0abfc 0%, #c084fc 25%, #818cf8 50%, #22d3ee 75%, #4ade80 100%);
        }
        .frame-birthday-elegant {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            border: 3px solid #c084fc;
        }
        
        /* 情人節 & 婚禮系列 */
        .frame-valentine {
            background: linear-gradient(135deg, #fecdd3 0%, #fb7185 50%, #f43f5e 100%);
        }
        .frame-valentine-rose {
            background: linear-gradient(135deg, #be123c 0%, #e11d48 50%, #f43f5e 100%);
        }
        .frame-wedding {
            background: linear-gradient(135deg, #ffffff 0%, #fdf4ff 50%, #fae8ff 100%);
            border: 3px solid #e9d5ff;
        }
        .frame-wedding-gold {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fde68a 100%);
            border: 3px solid #d97706;
        }
        
        /* 季節系列 */
        .frame-summer {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 50%, #7dd3fc 100%);
        }
        .frame-autumn {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 25%, #fb923c 50%, #fdba74 100%);
        }
        .frame-halloween {
            background: linear-gradient(135deg, #1c1917 0%, #f97316 50%, #1c1917 100%);
        }
        .frame-gradient-rainbow {
            background: linear-gradient(135deg, #f87171 0%, #fbbf24 20%, #4ade80 40%, #22d3ee 60%, #818cf8 80%, #e879f9 100%);
        }
        
        .frame-vintage {
            background: #f5f0e6;
            border: 3px solid #d4c4a8;
        }

        /* === Filter Styles === */
        .filter-none { filter: none; }
        .filter-vintage { filter: sepia(0.4) contrast(1.1) brightness(1.05) saturate(0.8); }
        .filter-bw { filter: grayscale(1) contrast(1.1); }
        .filter-warm { filter: sepia(0.2) saturate(1.3) brightness(1.05); }
        .filter-cool { filter: saturate(0.9) brightness(1.1) hue-rotate(10deg); }
        .filter-faded { filter: contrast(0.9) brightness(1.1) saturate(0.8); }
        .filter-dramatic { filter: contrast(1.3) saturate(1.2) brightness(0.95); }
        .filter-soft { filter: contrast(0.95) brightness(1.1) blur(0.5px); }

        /* === Wide Layout === */
        .wide-layout {
            display: flex;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        /* Side Panel */
        .side-panel {
            width: 360px;
            min-width: 360px;
            height: 100vh;
            background: linear-gradient(180deg, #ffffff 0%, #f8faf9 100%);
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .side-panel.collapsed {
            width: 70px;
            min-width: 70px;
        }

        .panel-toggle {
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background: white;
            border: none;
            border-radius: 0 10px 10px 0;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .panel-toggle:hover {
            background: #f0f0f0;
        }

        .side-panel.collapsed .panel-toggle .toggle-icon {
            transform: rotate(180deg);
        }

        .toggle-icon {
            font-size: 14px;
            color: #666;
            transition: transform 0.3s;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #5a8274 0%, #6b9b8a 100%);
            color: white;
        }

        .side-panel.collapsed .panel-header {
            padding: 15px 10px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            white-space: nowrap;
        }

        .side-panel.collapsed .panel-title {
            font-size: 0;
        }

        .side-panel.collapsed .panel-title::before {
            content: '⚙️';
            font-size: 20px;
        }

        .panel-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Vertical Tabs */
        .vertical-tabs {
            width: 70px;
            min-width: 70px;
            background: #f5f7f6;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-right: 1px solid #eee;
            overflow-y: auto;
        }

        .vtab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 4px;
        }

        .vtab-btn:hover {
            background: #e8f0ed;
        }

        .vtab-btn.active {
            background: #5a8274;
            color: white;
        }

        .vtab-icon {
            font-size: 20px;
        }

        .vtab-text {
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .side-panel.collapsed .vtab-text {
            display: none;
        }

        /* Tab Contents in Side Panel */
        .tab-contents {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .side-panel.collapsed .tab-contents {
            display: none;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 50%, #fce4ec 100%);
            overflow: hidden;
            padding: 20px;
        }

        .main-header {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        /* Camera Container in Wide Layout */
        .camera-container {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Quick Actions */
        .quick-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .quick-btn {
            width: 45px;
            height: 45px;
            background: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 3px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .quick-btn.active {
            background: #5a8274;
            color: white;
        }

        /* Photo Container in Wide Layout */
        .photo-container-wide {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        /* Responsive for smaller screens */
        @media (max-width: 900px) {
            .wide-layout {
                flex-direction: column;
            }
            
            .side-panel {
                width: 100%;
                min-width: 100%;
                height: auto;
                max-height: 50vh;
            }

            .side-panel.collapsed {
                width: 100%;
                min-width: 100%;
                max-height: 60px;
            }

            .panel-toggle {
                right: 50%;
                transform: translateX(50%);
                top: auto;
                bottom: -15px;
                width: 60px;
                height: 30px;
                border-radius: 0 0 10px 10px;
            }

            .side-panel.collapsed .panel-toggle .toggle-icon {
                transform: rotate(90deg);
            }

            .toggle-icon {
                transform: rotate(-90deg);
            }

            .panel-content {
                flex-direction: row;
            }

            .vertical-tabs {
                width: auto;
                min-width: auto;
                flex-direction: row;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .main-content {
                flex: 1;
                min-height: 50vh;
            }
        }

        /* === Control Panel (legacy support) === */
        .control-panel {
            background: white/95;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 15px;
            max-width: 95vw;
            overflow: hidden;
        }

        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #5a8274;
            color: white;
        }
        .tab-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .tab-content {
            display: none;
            padding: 10px 5px;
            overflow-y: auto;
        }
        .tab-content.active { display: block; }

        /* Tab content in side panel */
        .tab-contents .tab-content {
            max-height: calc(100vh - 180px);
        }

        .option-btn {
            padding: 8px 14px;
            border-radius: 15px;
            font-size: 12px;
            background: #f5f5f5;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .option-btn:hover { background: #e8e8e8; }
        .option-btn.active {
            border-color: #5a8274;
            background: #e8f5f0;
            color: #5a8274;
            font-weight: 600;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-switch {
            width: 44px; height: 24px;
            background: #ddd;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active { background: #5a8274; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
        }
        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            background: #5a8274;
            border-radius: 50%;
            cursor: pointer;
        }

        /* === Sticker & Drawing Panel === */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }
        .sticker-item {
            font-size: 28px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .sticker-item:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }

        .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .color-dot {
            width: 30px; height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: #333; }

        /* === Photo Edit Modal === */
        .edit-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9);
            z-index: 500;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .edit-modal.active { display: flex; }

        .edit-canvas-container {
            position: relative;
            max-width: 90vw;
            max-height: 60vh;
        }
        .edit-canvas {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 10px;
        }
        .drawing-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            cursor: crosshair;
        }

        .edit-toolbar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .edit-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .edit-btn.primary {
            background: #5a8274;
            color: white;
        }
        .edit-btn.secondary {
            background: white;
            color: #333;
        }
        .edit-btn:hover { transform: scale(1.05); }

        /* Draggable sticker on photo */
        .photo-sticker {
            position: absolute;
            font-size: 40px;
            cursor: move;
            user-select: none;
            z-index: 10;
        }
        .photo-sticker:hover {
            transform: scale(1.1);
        }

        /* Photo text overlay */
        .photo-text {
            position: absolute;
            font-family: 'Caveat', cursive;
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            cursor: move;
            user-select: none;
            z-index: 10;
        }

        /* === Flash Effect === */
        .flash-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 999;
        }
        @keyframes flashBurst {
            0% { opacity: 0; }
            10% { opacity: 1; }
            100% { opacity: 0; }
        }
        .flash-active { animation: flashBurst 0.3s ease-out; }

        /* === Animations === */
        @keyframes ejectFilm {
            0% { transform: translate(0, 0) rotate(0deg) scale(0.5); opacity: 0; z-index: 5; }
            30% { opacity: 1; transform: translate(60px, -180px) rotate(5deg) scale(0.8); z-index: 5; }
            60% { z-index: 25; }
            100% { transform: translate(180px, 80px) rotate(10deg) scale(1); z-index: 30; }
        }
        .ejecting {
            display: block;
            animation: ejectFilm 1s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* Close & Download buttons */
        .close-btn {
            position: absolute;
            top: -10px; right: -10px;
            width: 28px; height: 28px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50;
            font-size: 18px;
        }
        .polaroid-detail:hover .close-btn { opacity: 1; }

        .photo-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .action-btn {
            flex: 1;
            padding: 8px;
            background: rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        .action-btn:hover { background: rgba(0,0,0,0.1); }

        /* Text input in polaroid */
        .polaroid-text-input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-family: 'Caveat', cursive;
            font-size: 18px;
            color: #666;
            outline: none;
            padding: 10px 5px;
        }
        .polaroid-text-input::placeholder {
            color: #ccc;
        }

        /* Header styling */
        .instructions {
            font-family: 'Pacifico', cursive;
            color: #5a8274;
            text-shadow: 1px 1px 0px white;
        }

        /* Pattern backgrounds */
        .pattern-floral {
            background-color: #fff0f5;
            background-image: 
                radial-gradient(#ffb7b2 20%, transparent 20%),
                radial-gradient(#ffdac1 20%, transparent 20%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .pattern-plaid {
            background-color: #e0f2fe;
            background-image:
                repeating-linear-gradient(90deg, transparent, transparent 19px, #bae6fd 19px, #bae6fd 20px),
                repeating-linear-gradient(0deg, transparent, transparent 19px, #bae6fd 19px, #bae6fd 20px);
        }

        /* Burst mode indicator */
        .burst-indicator {
            position: fixed;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            background: #ff6b6b;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 100;
            display: none;
        }
        .burst-indicator.active { display: block; }

        /* Date stamp */
        .date-stamp {
            position: absolute;
            bottom: 10px; right: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #ff6b00;
            font-weight: bold;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .camera-body {
                transform: scale(0.85);
            }
            .control-panel {
                padding: 10px;
            }
            .tab-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .camera-body {
                transform: scale(0.7);
            }
        }

        /* Camera Color Option */
        .camera-color-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .camera-color-option:hover {
            background: #f5f5f5;
            transform: scale(1.05);
        }
        .camera-color-option.active {
            border-color: #5a8274;
            background: #e8f5f0;
        }
        .camera-color-option .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 2px 2px 4px rgba(255,255,255,0.5);
        }
        .camera-color-option span {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        /* AI Style Section */
        .ai-api-section {
            border: 1px solid #e5e7eb;
        }
        .api-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }
        .api-input:focus {
            border-color: #5a8274;
        }
        .api-test-btn {
            padding: 8px 16px;
            background: #5a8274;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .api-test-btn:hover {
            background: #4a7264;
        }
        .api-test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .api-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .api-status.disconnected {
            background: #fee2e2;
            color: #dc2626;
        }
        .api-status.disconnected .status-dot {
            background: #dc2626;
        }
        .api-status.connected {
            background: #dcfce7;
            color: #16a34a;
        }
        .api-status.connected .status-dot {
            background: #16a34a;
            animation: pulse 2s infinite;
        }
        .api-status.connecting {
            background: #fef3c7;
            color: #d97706;
        }
        .api-status.connecting .status-dot {
            background: #d97706;
            animation: blink 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .ai-style-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .ai-style-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 5px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #fafafa;
        }
        .ai-style-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .ai-style-card.active {
            border-color: #5a8274;
            background: #e8f5f0;
        }
        .ai-style-card.processing {
            pointer-events: none;
            opacity: 0.7;
        }
        .ai-style-card.processing .ai-style-preview::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 20px; height: 20px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .ai-style-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .ai-style-name {
            font-size: 10px;
            color: #555;
            font-weight: 500;
            text-align: center;
        }

        /* AI Processing Modal */
        .ai-processing-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
            gap: 20px;
        }
        .ai-processing-modal.active {
            display: flex;
        }
        .ai-processing-spinner {
            width: 60px; height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .ai-processing-text {
            color: white;
            font-size: 16px;
            text-align: center;
        }

        /* Camera color themes */
        .camera-mint {
            background: linear-gradient(135deg, #cbf0de 0%, #b2e2cd 50%, #9ad4bd 100%) !important;
        }
        .camera-mint .lens-mount {
            background: radial-gradient(circle, #cbf0de 40%, #a5dcc5 100%) !important;
        }
        .camera-mint .lens-ring-outer {
            background: linear-gradient(135deg, #b8e6d3, #9adbc0) !important;
        }
        .camera-mint .shutter-socket {
            background: linear-gradient(135deg, #aaddc8, #cbf0de) !important;
        }
        .camera-mint .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #e0fff4 0%, #a2dcc0 40%, #8bc4aa 100%) !important;
        }

        .camera-pink {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 50%, #f9a8d4 100%) !important;
        }
        .camera-pink .lens-mount {
            background: radial-gradient(circle, #fce7f3 40%, #fbcfe8 100%) !important;
        }
        .camera-pink .lens-ring-outer {
            background: linear-gradient(135deg, #fbcfe8, #f9a8d4) !important;
        }
        .camera-pink .shutter-socket {
            background: linear-gradient(135deg, #f9a8d4, #fce7f3) !important;
        }
        .camera-pink .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #fff0f7 0%, #f9a8d4 40%, #ec4899 100%) !important;
        }
        .camera-pink .lens-text text { fill: #be185d !important; }
        .camera-pink .mode-indicator { color: #be185d !important; }

        .camera-blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%) !important;
        }
        .camera-blue .lens-mount {
            background: radial-gradient(circle, #dbeafe 40%, #bfdbfe 100%) !important;
        }
        .camera-blue .lens-ring-outer {
            background: linear-gradient(135deg, #bfdbfe, #93c5fd) !important;
        }
        .camera-blue .shutter-socket {
            background: linear-gradient(135deg, #93c5fd, #dbeafe) !important;
        }
        .camera-blue .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #eff6ff 0%, #93c5fd 40%, #3b82f6 100%) !important;
        }
        .camera-blue .lens-text text { fill: #1d4ed8 !important; }
        .camera-blue .mode-indicator { color: #1d4ed8 !important; }

        .camera-purple {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 50%, #d8b4fe 100%) !important;
        }
        .camera-purple .lens-mount {
            background: radial-gradient(circle, #f3e8ff 40%, #e9d5ff 100%) !important;
        }
        .camera-purple .lens-ring-outer {
            background: linear-gradient(135deg, #e9d5ff, #d8b4fe) !important;
        }
        .camera-purple .shutter-socket {
            background: linear-gradient(135deg, #d8b4fe, #f3e8ff) !important;
        }
        .camera-purple .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #faf5ff 0%, #d8b4fe 40%, #a855f7 100%) !important;
        }
        .camera-purple .lens-text text { fill: #7e22ce !important; }
        .camera-purple .mode-indicator { color: #7e22ce !important; }

        .camera-yellow {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 50%, #fef08a 100%) !important;
        }
        .camera-yellow .lens-mount {
            background: radial-gradient(circle, #fefce8 40%, #fef9c3 100%) !important;
        }
        .camera-yellow .lens-ring-outer {
            background: linear-gradient(135deg, #fef9c3, #fef08a) !important;
        }
        .camera-yellow .shutter-socket {
            background: linear-gradient(135deg, #fef08a, #fefce8) !important;
        }
        .camera-yellow .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #fffef0 0%, #fef08a 40%, #eab308 100%) !important;
        }
        .camera-yellow .lens-text text { fill: #a16207 !important; }
        .camera-yellow .mode-indicator { color: #a16207 !important; }

        .camera-white {
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 50%, #e5e7eb 100%) !important;
        }
        .camera-white .lens-mount {
            background: radial-gradient(circle, #ffffff 40%, #f3f4f6 100%) !important;
        }
        .camera-white .lens-ring-outer {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb) !important;
        }
        .camera-white .shutter-socket {
            background: linear-gradient(135deg, #e5e7eb, #ffffff) !important;
        }
        .camera-white .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #ffffff 0%, #e5e7eb 40%, #9ca3af 100%) !important;
        }
        .camera-white .lens-text text { fill: #4b5563 !important; }
        .camera-white .mode-indicator { color: #4b5563 !important; }

        .camera-black {
            background: linear-gradient(135deg, #4b5563 0%, #374151 50%, #1f2937 100%) !important;
        }
        .camera-black .lens-mount {
            background: radial-gradient(circle, #4b5563 40%, #374151 100%) !important;
        }
        .camera-black .lens-ring-outer {
            background: linear-gradient(135deg, #374151, #1f2937) !important;
        }
        .camera-black .shutter-socket {
            background: linear-gradient(135deg, #374151, #4b5563) !important;
        }
        .camera-black .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #6b7280 0%, #374151 40%, #111827 100%) !important;
        }
        .camera-black .flash {
            background: linear-gradient(135deg, #9ca3af, #6b7280) !important;
        }
        .camera-black .lens-text text { fill: #9ca3af !important; }
        .camera-black .mode-indicator { color: #9ca3af !important; background: #374151 !important; }

        .camera-coral {
            background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 50%, #fdba74 100%) !important;
        }
        .camera-coral .lens-mount {
            background: radial-gradient(circle, #ffedd5 40%, #fed7aa 100%) !important;
        }
        .camera-coral .lens-ring-outer {
            background: linear-gradient(135deg, #fed7aa, #fdba74) !important;
        }
        .camera-coral .shutter-socket {
            background: linear-gradient(135deg, #fdba74, #ffedd5) !important;
        }
        .camera-coral .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #fff7ed 0%, #fdba74 40%, #f97316 100%) !important;
        }
        .camera-coral .lens-text text { fill: #c2410c !important; }
        .camera-coral .mode-indicator { color: #c2410c !important; }

        .camera-red {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%) !important;
        }
        .camera-red .lens-mount {
            background: radial-gradient(circle, #fecaca 40%, #fca5a5 100%) !important;
        }
        .camera-red .lens-ring-outer {
            background: linear-gradient(135deg, #fca5a5, #f87171) !important;
        }
        .camera-red .shutter-socket {
            background: linear-gradient(135deg, #f87171, #fecaca) !important;
        }
        .camera-red .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #fff5f5 0%, #f87171 40%, #dc2626 100%) !important;
        }
        .camera-red .lens-text text { fill: #b91c1c !important; }
        .camera-red .mode-indicator { color: #b91c1c !important; }

        .camera-caramel {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%) !important;
        }
        .camera-caramel .lens-mount {
            background: radial-gradient(circle, #fef3c7 40%, #fde68a 100%) !important;
        }
        .camera-caramel .lens-ring-outer {
            background: linear-gradient(135deg, #fde68a, #fcd34d) !important;
        }
        .camera-caramel .shutter-socket {
            background: linear-gradient(135deg, #fcd34d, #fef3c7) !important;
        }
        .camera-caramel .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #fffbeb 0%, #fcd34d 40%, #d97706 100%) !important;
        }
        .camera-caramel .lens-text text { fill: #92400e !important; }
        .camera-caramel .mode-indicator { color: #92400e !important; }

        .camera-forest {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%) !important;
        }
        .camera-forest .lens-mount {
            background: radial-gradient(circle, #d1fae5 40%, #a7f3d0 100%) !important;
        }
        .camera-forest .lens-ring-outer {
            background: linear-gradient(135deg, #a7f3d0, #6ee7b7) !important;
        }
        .camera-forest .shutter-socket {
            background: linear-gradient(135deg, #6ee7b7, #d1fae5) !important;
        }
        .camera-forest .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #ecfdf5 0%, #6ee7b7 40%, #059669 100%) !important;
        }
        .camera-forest .lens-text text { fill: #047857 !important; }
        .camera-forest .mode-indicator { color: #047857 !important; }

        .camera-slate {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 50%, #94a3b8 100%) !important;
        }
        .camera-slate .lens-mount {
            background: radial-gradient(circle, #e2e8f0 40%, #cbd5e1 100%) !important;
        }
        .camera-slate .lens-ring-outer {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8) !important;
        }
        .camera-slate .shutter-socket {
            background: linear-gradient(135deg, #94a3b8, #e2e8f0) !important;
        }
        .camera-slate .shutter-btn {
            background: radial-gradient(circle at 35% 35%, #f8fafc 0%, #94a3b8 40%, #475569 100%) !important;
        }
        .camera-slate .lens-text text { fill: #334155 !important; }
        .camera-slate .mode-indicator { color: #334155 !important; }
    </style>
</head>
<body class="min-h-screen relative overflow-hidden">

    <!-- Flash Overlay -->
    <div id="flashOverlay" class="flash-overlay"></div>

    <!-- AI Processing Modal -->
    <div id="aiProcessingModal" class="ai-processing-modal">
        <div class="ai-processing-spinner"></div>
        <div class="ai-processing-text">
            <div id="aiProcessingStatus">🎨 AI 正在創作中...</div>
            <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">請稍候片刻</div>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdownOverlay" class="countdown-overlay">
        <div id="countdownNumber" class="countdown-number">3</div>
    </div>

    <!-- Burst Mode Indicator -->
    <div id="burstIndicator" class="burst-indicator">📸 連拍中... <span id="burstCount">0</span>/4</div>

    <!-- Hidden Canvases -->
    <canvas id="canvas" class="hidden"></canvas>
    <canvas id="previewCanvas" class="hidden"></canvas>

    <!-- Main Wide Layout Container -->
    <div class="wide-layout">
        
        <!-- Left Sidebar - Control Panel -->
        <div id="sidePanel" class="side-panel">
            <!-- Panel Toggle Button -->
            <button id="panelToggle" class="panel-toggle" onclick="toggleSidePanel()">
                <span class="toggle-icon">◀</span>
            </button>
            
            <!-- Panel Header -->
            <div class="panel-header">
                <h2 class="panel-title">⚙️ 設定</h2>
            </div>
            
            <!-- Panel Content -->
            <div class="panel-content">
                <!-- Vertical Tabs -->
                <div class="vertical-tabs">
                    <button class="vtab-btn active" onclick="switchTab('frames')" data-tab="frames">
                        <span class="vtab-icon">🖼️</span>
                        <span class="vtab-text">相框</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('filters')" data-tab="filters">
                        <span class="vtab-icon">🎨</span>
                        <span class="vtab-text">濾鏡</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('ai-style')" data-tab="ai-style">
                        <span class="vtab-icon">🤖</span>
                        <span class="vtab-text">AI風格</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('camera')" data-tab="camera">
                        <span class="vtab-icon">📷</span>
                        <span class="vtab-text">相機</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('beauty')" data-tab="beauty">
                        <span class="vtab-icon">✨</span>
                        <span class="vtab-text">美肌</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('stickers')" data-tab="stickers">
                        <span class="vtab-icon">😀</span>
                        <span class="vtab-text">貼圖</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('appearance')" data-tab="appearance">
                        <span class="vtab-icon">🎀</span>
                        <span class="vtab-text">外觀</span>
                    </button>
                    <button class="vtab-btn" onclick="switchTab('settings')" data-tab="settings">
                        <span class="vtab-icon">⚙️</span>
                        <span class="vtab-text">設定</span>
                    </button>
                </div>

                <!-- Tab Contents -->
                <div class="tab-contents">
                    <!-- Frames Tab -->
                    <div id="tab-frames" class="tab-content active">
                        <div class="mb-3">
                            <p class="text-xs text-gray-500 mb-2 font-medium">基本相框</p>
                            <div class="flex gap-2 flex-wrap">
                                <button class="option-btn active" onclick="selectFrame('white')">⬜ 經典白</button>
                                <button class="option-btn" onclick="selectFrame('black')">⬛ 黑色</button>
                                <button class="option-btn" onclick="selectFrame('mint')">🟢 薄荷</button>
                                <button class="option-btn" onclick="selectFrame('pink')">🩷 粉紅</button>
                                <button class="option-btn" onclick="selectFrame('vintage')">📜 復古</button>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-2 font-medium">🎄 聖誕節</p>
                            <div class="flex gap-2 flex-wrap mb-3">
                                <button class="option-btn" onclick="selectFrame('christmas')">🎅 經典紅綠</button>
                                <button class="option-btn" onclick="selectFrame('christmas-gold')">✨ 金色聖誕</button>
                                <button class="option-btn" onclick="selectFrame('christmas-snow')">❄️ 白雪飄飄</button>
                                <button class="option-btn" onclick="selectFrame('christmas-cozy')">🧣 溫馨小屋</button>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 font-medium">🎊 新年</p>
                            <div class="flex gap-2 flex-wrap mb-3">
                                <button class="option-btn" onclick="selectFrame('newyear')">🎆 跨年煙火</button>
                                <button class="option-btn" onclick="selectFrame('newyear-gold')">🏆 金碧輝煌</button>
                                <button class="option-btn" onclick="selectFrame('cny')">🧧 農曆新年</button>
                                <button class="option-btn" onclick="selectFrame('cny-dragon')">🐉 祥龍獻瑞</button>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 font-medium">🎂 生日</p>
                            <div class="flex gap-2 flex-wrap mb-3">
                                <button class="option-btn" onclick="selectFrame('birthday')">🎈 氣球派對</button>
                                <button class="option-btn" onclick="selectFrame('birthday-pastel')">🧁 粉嫩甜心</button>
                                <button class="option-btn" onclick="selectFrame('birthday-neon')">🎉 霓虹狂歡</button>
                                <button class="option-btn" onclick="selectFrame('birthday-elegant')">🥂 優雅金緻</button>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 font-medium">💕 情人節 & 婚禮</p>
                            <div class="flex gap-2 flex-wrap mb-3">
                                <button class="option-btn" onclick="selectFrame('valentine')">💝 甜蜜愛心</button>
                                <button class="option-btn" onclick="selectFrame('valentine-rose')">🌹 玫瑰情緣</button>
                                <button class="option-btn" onclick="selectFrame('wedding')">💒 純白婚禮</button>
                                <button class="option-btn" onclick="selectFrame('wedding-gold')">💍 金色誓約</button>
                            </div>
                            <p class="text-xs text-gray-500 mb-2 font-medium">🌈 季節 & 其他</p>
                            <div class="flex gap-2 flex-wrap">
                                <button class="option-btn" onclick="selectFrame('floral')">🌸 春日花漾</button>
                                <button class="option-btn" onclick="selectFrame('summer')">🌊 夏日海洋</button>
                                <button class="option-btn" onclick="selectFrame('autumn')">🍂 秋楓落葉</button>
                                <button class="option-btn" onclick="selectFrame('halloween')">🎃 萬聖驚魂</button>
                                <button class="option-btn" onclick="selectFrame('plaid')">🔲 經典格紋</button>
                                <button class="option-btn" onclick="selectFrame('gradient-rainbow')">🌈 彩虹漸層</button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters Tab -->
                    <div id="tab-filters" class="tab-content">
                        <div class="flex gap-2 flex-wrap">
                            <button class="option-btn active" onclick="selectFilter('none')">🔲 無</button>
                            <button class="option-btn" onclick="selectFilter('vintage')">📷 復古</button>
                            <button class="option-btn" onclick="selectFilter('bw')">🖤 黑白</button>
                            <button class="option-btn" onclick="selectFilter('warm')">🌅 暖色</button>
                            <button class="option-btn" onclick="selectFilter('cool')">❄️ 冷色</button>
                            <button class="option-btn" onclick="selectFilter('faded')">🌫️ 褪色</button>
                            <button class="option-btn" onclick="selectFilter('dramatic')">🎭 戲劇</button>
                            <button class="option-btn" onclick="selectFilter('soft')">☁️ 柔和</button>
                        </div>
                    </div>

                    <!-- AI Style Tab -->
                    <div id="tab-ai-style" class="tab-content">
                        <div class="ai-api-section mb-4 p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium">🔑 Groq API</span>
                                <div id="apiStatus" class="api-status disconnected">
                                    <span class="status-dot"></span>
                                    <span class="status-text">未連線</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input type="password" id="groqApiKey" class="api-input" placeholder="輸入 gsk_ 開頭的 API Key...">
                                <button onclick="testGroqConnection()" class="api-test-btn">測試</button>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">
                                <a href="https://console.groq.com/keys" target="_blank" class="text-blue-500 hover:underline">取得 Groq API Key →</a>
                            </p>
                        </div>
                        <div class="ai-styles-section">
                            <p class="text-xs text-gray-500 mb-1 font-medium">🎨 AI 創作風格</p>
                            <p class="text-xs text-green-600 mb-2">✓ Groq + Pollinations 圖像生成</p>
                            <div class="ai-style-grid">
                                <div class="ai-style-card active" onclick="selectAIStyle('none')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #f5f5f5, #e0e0e0);"><span>🚫</span></div>
                                    <span class="ai-style-name">不套用</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('anime')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #ff9a9e, #fecfef);"><span>🎌</span></div>
                                    <span class="ai-style-name">動漫</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('ghibli')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #a8edea, #fed6e3);"><span>🏯</span></div>
                                    <span class="ai-style-name">吉卜力</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('oil-painting')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #667eea, #764ba2);"><span>🖼️</span></div>
                                    <span class="ai-style-name">油畫</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('watercolor')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #89f7fe, #66a6ff);"><span>🎨</span></div>
                                    <span class="ai-style-name">水彩</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('sketch')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #d299c2, #fef9d7);"><span>✏️</span></div>
                                    <span class="ai-style-name">素描</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('cyberpunk')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #0f0c29, #302b63);"><span>🌃</span></div>
                                    <span class="ai-style-name">賽博龐克</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('pixel-art')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #11998e, #38ef7d);"><span>👾</span></div>
                                    <span class="ai-style-name">像素</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('pop-art')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #ff416c, #ff4b2b);"><span>🎪</span></div>
                                    <span class="ai-style-name">普普</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('impressionist')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #f093fb, #f5576c);"><span>🌻</span></div>
                                    <span class="ai-style-name">印象派</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('3d-cartoon')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"><span>🧸</span></div>
                                    <span class="ai-style-name">3D卡通</span>
                                </div>
                                <div class="ai-style-card" onclick="selectAIStyle('comic')">
                                    <div class="ai-style-preview" style="background: linear-gradient(135deg, #fa709a, #fee140);"><span>💥</span></div>
                                    <span class="ai-style-name">美漫</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Tab -->
                    <div id="tab-camera" class="tab-content">
                        <div class="space-y-4">
                            <div>
                                <p class="text-xs text-gray-500 mb-2 font-medium">拍攝模式</p>
                                <div class="flex flex-col gap-2">
                                    <button class="option-btn active" onclick="setShootMode('normal')">📸 一般</button>
                                    <button class="option-btn" onclick="setShootMode('burst')">⚡ 連拍 (4張)</button>
                                    <button class="option-btn" onclick="setShootMode('blur')">🎨 人像模糊</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-2 font-medium">倒數計時</p>
                                <div class="flex flex-col gap-2">
                                    <button class="option-btn active" onclick="setTimer(0)">⏱️ 關閉</button>
                                    <button class="option-btn" onclick="setTimer(3)">⏱️ 3 秒</button>
                                    <button class="option-btn" onclick="setTimer(5)">⏱️ 5 秒</button>
                                    <button class="option-btn" onclick="setTimer(10)">⏱️ 10 秒</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-2 font-medium">照片比例</p>
                                <div class="flex flex-col gap-2">
                                    <button class="option-btn active" onclick="setRatio('1:1')">📐 1:1 正方形</button>
                                    <button class="option-btn" onclick="setRatio('4:3')">📐 4:3 標準</button>
                                    <button class="option-btn" onclick="setRatio('16:9')">📐 16:9 寬螢幕</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Beauty Tab -->
                    <div id="tab-beauty" class="tab-content">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-medium">✨ 美肌模式</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="beautyToggle" class="sr-only peer" checked onchange="toggleBeauty()">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                        <div class="space-y-4" id="beautyControls">
                            <div>
                                <label class="text-xs text-gray-500">亮白 <span id="brightnessValue">105</span>%</label>
                                <input type="range" min="80" max="130" value="105" class="w-full" id="brightnessSlider" oninput="updateBeauty('brightness', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">磨皮 <span id="smoothnessValue">1</span></label>
                                <input type="range" min="0" max="5" value="1" class="w-full" id="smoothnessSlider" oninput="updateBeauty('smoothness', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">曝光 <span id="exposureValue">102</span>%</label>
                                <input type="range" min="80" max="130" value="102" class="w-full" id="exposureSlider" oninput="updateBeauty('exposure', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">對比 <span id="contrastValue">98</span>%</label>
                                <input type="range" min="80" max="130" value="98" class="w-full" id="contrastSlider" oninput="updateBeauty('contrast', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Stickers Tab -->
                    <div id="tab-stickers" class="tab-content">
                        <p class="text-xs text-gray-500 mb-2">選擇貼圖後點擊照片添加</p>
                        <div class="sticker-grid">
                            <div class="sticker-item" onclick="selectSticker('❤️')">❤️</div>
                            <div class="sticker-item" onclick="selectSticker('⭐')">⭐</div>
                            <div class="sticker-item" onclick="selectSticker('🎀')">🎀</div>
                            <div class="sticker-item" onclick="selectSticker('🌸')">🌸</div>
                            <div class="sticker-item" onclick="selectSticker('✨')">✨</div>
                            <div class="sticker-item" onclick="selectSticker('🦋')">🦋</div>
                            <div class="sticker-item" onclick="selectSticker('🌈')">🌈</div>
                            <div class="sticker-item" onclick="selectSticker('🎉')">🎉</div>
                            <div class="sticker-item" onclick="selectSticker('💫')">💫</div>
                            <div class="sticker-item" onclick="selectSticker('🔥')">🔥</div>
                            <div class="sticker-item" onclick="selectSticker('💖')">💖</div>
                            <div class="sticker-item" onclick="selectSticker('🎄')">🎄</div>
                            <div class="sticker-item" onclick="selectSticker('🎅')">🎅</div>
                            <div class="sticker-item" onclick="selectSticker('⛄')">⛄</div>
                            <div class="sticker-item" onclick="selectSticker('🎁')">🎁</div>
                            <div class="sticker-item" onclick="selectSticker('🍀')">🍀</div>
                            <div class="sticker-item" onclick="selectSticker('🌺')">🌺</div>
                            <div class="sticker-item" onclick="selectSticker('🎂')">🎂</div>
                            <div class="sticker-item" onclick="selectSticker('🎈')">🎈</div>
                            <div class="sticker-item" onclick="selectSticker('😍')">😍</div>
                            <div class="sticker-item" onclick="selectSticker('😎')">😎</div>
                            <div class="sticker-item" onclick="selectSticker('🥰')">🥰</div>
                            <div class="sticker-item" onclick="selectSticker('😊')">😊</div>
                            <div class="sticker-item" onclick="selectSticker('🤩')">🤩</div>
                        </div>
                        <button onclick="clearSticker()" class="mt-3 text-sm text-gray-500 hover:text-gray-700">清除選擇</button>
                    </div>

                    <!-- Appearance Tab -->
                    <div id="tab-appearance" class="tab-content">
                        <p class="text-xs text-gray-500 mb-3 font-medium">🎨 相機外觀顏色</p>
                        <div class="grid grid-cols-4 gap-2">
                            <div class="camera-color-option active" onclick="setCameraColor('mint')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);"></div>
                                <span>薄荷綠</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('pink')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);"></div>
                                <span>櫻花粉</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('blue')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);"></div>
                                <span>天空藍</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('purple')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);"></div>
                                <span>薰衣草</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('yellow')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #fef3c7, #fde68a);"></div>
                                <span>奶油黃</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('white')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #ffffff, #f3f4f6);"></div>
                                <span>純淨白</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('black')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #4b5563, #1f2937);"></div>
                                <span>經典黑</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('coral')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #ffedd5, #fdba74);"></div>
                                <span>珊瑚橘</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('red')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #fecaca, #f87171);"></div>
                                <span>熱情紅</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('caramel')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #fef3c7, #fcd34d);"></div>
                                <span>焦糖金</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('forest')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #d1fae5, #6ee7b7);"></div>
                                <span>森林綠</span>
                            </div>
                            <div class="camera-color-option" onclick="setCameraColor('slate')">
                                <div class="color-preview" style="background: linear-gradient(135deg, #e2e8f0, #94a3b8);"></div>
                                <span>岩石灰</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="tab-settings" class="tab-content">
                        <div class="space-y-3">
                            <label class="flex items-center justify-between">
                                <span class="text-sm">📅 日期標記</span>
                                <input type="checkbox" onchange="toggleDate()" class="w-5 h-5">
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-sm">🔊 快門音效</span>
                                <input type="checkbox" checked onchange="toggleSound()" class="w-5 h-5">
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-sm">💾 自動儲存</span>
                                <input type="checkbox" onchange="toggleAutoSave()" class="w-5 h-5">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- School Badge Image -->
            <img src="校徽cute版.png" alt="School Badge" class="school-badge">
            
            <!-- 新增：功能介紹氣泡提示框 -->
            <div id="featureTooltip" class="feature-tooltip"></div>

            <!-- Header -->
            <div class="main-header">
                <h1 class="text-3xl md:text-4xl mb-1 instructions">Retro Mint Cam</h1>
                <p id="modeDisplay" class="text-gray-500 text-xs">MODE: NORMAL</p>
            </div>

            <!-- Quick Action Buttons -->
            <div class="quick-actions">
                <button onclick="openGallery()" class="quick-btn" title="相簿">📁</button>
                <button onclick="switchCamera()" class="quick-btn" title="切換鏡頭">🔄</button>
                <button onclick="toggleFlash()" id="flashBtn" class="quick-btn" title="閃光燈">⚡</button>
                <button onclick="toggleGrid()" id="gridBtn" class="quick-btn" title="格線">#</button>
            </div>

            <!-- Photo Container -->
            <div id="photoDetailsContainer" class="photo-container-wide"></div>

            <!-- Camera Container -->
            <div class="camera-container">
                <!-- 3D Camera -->
                <div id="cameraBody" class="camera-body camera-mint">
                    <div class="camera-grip"></div>
                    <div class="flash"></div>
                    <div class="viewfinder"></div>
                    <div class="sensor-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>

                    <!-- Shutter Button -->
                    <div class="shutter-socket">
                        <button id="shutterBtn" class="shutter-btn" title="拍照">
                            <div id="modeIndicator" class="mode-indicator">M</div>
                        </button>
                    </div>

                    <!-- Lens Assembly -->
                    <div class="lens-mount">
                        <div class="lens-ring-outer">
                            <div class="lens-text">
                                <svg viewBox="0 0 200 200">
                                    <path id="curve" d="M 100, 100 m -75, 0 a 75,75 0 1,1 150,0 a 75,75 0 1,1 -150,0" />
                                    <text width="500">
                                        <textPath xlink:href="#curve">
                                            INSTAX LENS 60mm FOCUS RANGE 0.3m~∞
                                        </textPath>
                                    </text>
                                </svg>
                            </div>
                            <div class="lens-glass" id="lensContainer">
                                <video id="video" autoplay playsinline muted></video>
                                <canvas id="livePreview" style="display:none;"></canvas>
                                <svg id="gridOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;display:none;pointer-events:none;">
                                    <line x1="33%" y1="0" x2="33%" y2="100%" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                                    <line x1="66%" y1="0" x2="66%" y2="100%" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                                    <line x1="0" y1="33%" x2="100%" y2="33%" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                                    <line x1="0" y1="66%" x2="100%" y2="66%" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="absolute top-6 left-14 text-left opacity-50 pointer-events-none">
                        <div class="font-bold text-gray-600 text-xs">instax</div>
                        <div class="font-bold text-gray-500 text-lg leading-3">mini PRO</div>
                    </div>
                </div>

                <!-- Ejecting Film -->
                <div id="polaroidFilm" class="polaroid-film bg-white">
                    <div class="polaroid-image-area">
                        <img id="filmImage" src="" alt="Developing Photo">
                    </div>
                    <div class="mt-4 text-center text-gray-400 text-sm" style="font-family: 'Pacifico', cursive;">
                        Memories
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="edit-modal">
        <button onclick="closeEditModal()" class="absolute top-4 right-4 text-white text-3xl">&times;</button>
        
        <div class="edit-canvas-container">
            <canvas id="editCanvas" class="edit-canvas"></canvas>
            <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
        </div>

        <div class="edit-toolbar">
            <button class="edit-btn secondary" onclick="setEditMode('sticker')">
                😀 貼紙
            </button>
            <button class="edit-btn secondary" onclick="setEditMode('text')">
                ✏️ 文字
            </button>
            <button class="edit-btn secondary" onclick="setEditMode('draw')">
                🖌️ 塗鴉
            </button>
            <div class="color-picker" id="editColorPicker" style="display:none;">
                <div class="color-dot active" style="background:#ff0000" onclick="setDrawColor('#ff0000')"></div>
                <div class="color-dot" style="background:#00ff00" onclick="setDrawColor('#00ff00')"></div>
                <div class="color-dot" style="background:#0000ff" onclick="setDrawColor('#0000ff')"></div>
                <div class="color-dot" style="background:#ffff00" onclick="setDrawColor('#ffff00')"></div>
                <div class="color-dot" style="background:#ff00ff" onclick="setDrawColor('#ff00ff')"></div>
                <div class="color-dot" style="background:#ffffff" onclick="setDrawColor('#ffffff')"></div>
                <div class="color-dot" style="background:#000000" onclick="setDrawColor('#000000')"></div>
            </div>
            <button class="edit-btn secondary" onclick="clearDrawing()">
                🗑️ 清除
            </button>
            <button class="edit-btn primary" onclick="saveEditedPhoto()">
                💾 儲存
            </button>
        </div>
    </div>

    <!-- Audio -->
    <audio id="shutterSound" preload="auto">
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAbAAqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV////////////////////////////////////////////AAAAAExhdmM1OC4xMwAAAAAAAAAAAAAAACQDgAAAAAAAAAGw9wrNaQAAAAAAAAAAAAAAAAD/4xjEAAQYAaQBQBAABMQBIAwGHgYGBiQQBAEAQBD5QEBwfB8H/KAgGP/BwEB8HwfwcP/Lh/5cEAQ/E/y4f/+D5//ygfBAEAwcBAMHAfB////lwQP/8HwfLggGD4IOBAP/jGMQWCogBoAHAGACH/8uf/BB//5c/0FP6gp8H0f//1RT/1f6n//9AfKin9X/+t+r//9BT//4Hof/o/9P+gfqH+v/U/1B//0f/oH+gfQP/jGMQeCoABoADAGAD/0f/R/6P/6qKf1f/6FP/oH//R/9H/qf/6P/UfoP/0f+j////r/R/6n+h/R/0f+n/9A+j////r/1P/1D/4xjEJgiIAaQAwBgA/6f1f1X/6v/6P/+h/0f/9T/q//of/9T/o//6H9BT9D/o/o/6H9f/+j/6H/T/of/6P/4xjELQhgAZwAwBgA/o/+j/6qj/+n//R/+r/9Q/1Af/6P////0D/R/1P//o/9D/9H/0f/6H/1f/6FP6/9H/0f6P//jGMQ3CMABoADAGAD/8H//qA/+r/0P/9X/6n/UB/o//o//q///Q/6A==" type="audio/mpeg">
    </audio>

    <script>
        // === State Variables ===
        let stream = null;
        let photoCount = 0;
        let facingMode = 'user';
        
        // Settings
        let currentFrame = 'white';
        let currentFilter = 'none';
        let shootMode = 'normal';
        let timerSeconds = 0;
        let photoRatio = '1:1';
        let beautyEnabled = true;  // 預設開啟美肌
        let dateEnabled = false;
        let soundEnabled = true;
        let autoSaveEnabled = false;
        let flashEnabled = false;
        let gridEnabled = false;
        let selectedSticker = null;

        // Beauty settings (預設美肌參數)
        let brightness = 105;   // 預設亮白
        let smoothness = 1;     // 預設輕微磨皮
        let exposure = 102;     // 預設曝光
        let contrast = 98;      // 預設對比

        // Edit mode
        let editMode = null;
        let drawColor = '#ff0000';
        let isDrawing = false;
        let currentEditPhoto = null;

        // AI Style settings - 使用 Groq API
        let groqApiKey = '';  // 不儲存 API Key
        let groqConnected = false;
        let currentAIStyle = 'none';
        
        // AI Style prompts - 強調保持原始人物特徵、表情和動作姿勢一致
        const aiStylePrompts = {
            'none': null,
            'anime': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to Japanese anime illustration style. Keep the same face identity, same expression, same pose, same angle. Apply anime aesthetics: vibrant colors, clean lines, expressive anime eyes while maintaining the original person recognizable identity.',
            'ghibli': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to Studio Ghibli style. Keep the same face identity, same expression, same pose. Apply Ghibli aesthetics: soft watercolor textures, warm nostalgic colors, whimsical Hayao Miyazaki art style while the person remains completely recognizable.',
            'oil-painting': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to classical oil painting. Keep the same face identity, same expression, same pose. Apply oil painting aesthetics: visible brush strokes, rich textures, dramatic Renaissance lighting while maintaining perfect likeness to the original person.',
            'watercolor': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to watercolor painting. Keep the same face identity, same expression, same pose. Apply watercolor aesthetics: soft flowing colors, gentle gradients, transparent medium effect while the person remains identical.',
            'sketch': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to detailed pencil sketch. Keep the same face identity, same expression, same pose. Apply sketch aesthetics: shading techniques, cross-hatching, fine lines while maintaining exact likeness.',
            'cyberpunk': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to cyberpunk. Keep the same face identity, same expression, same pose. Apply cyberpunk aesthetics: neon colors (pink, cyan, purple), futuristic lighting, holographic effects while the person is completely recognizable.',
            'pixel-art': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to pixel art. Keep the same face identity, same expression, same pose. Apply pixel art aesthetics: limited color palette, visible pixels, 8-bit/16-bit game style while maintaining recognizable likeness.',
            'pop-art': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to Andy Warhol Pop Art. Keep the same face identity, same expression, same pose. Apply pop art aesthetics: bright contrasting colors, Ben-Day dots, bold outlines while the person remains identical.',
            'impressionist': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to Impressionist painting like Monet. Keep the same face identity, same expression, same pose. Apply impressionist aesthetics: visible brush strokes, light emphasis, dreamy atmosphere while maintaining exact likeness.',
            '3d-cartoon': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to 3D Pixar/Disney cartoon. Keep the same face identity, same expression, same pose. Apply 3D cartoon aesthetics: smooth rounded features, polished animated film look while the person is completely recognizable.',
            'comic': 'CRITICAL: You MUST preserve the EXACT same person, facial features, expression, pose, body position, and composition from the original photo. Transform ONLY the artistic style to American comic book. Keep the same face identity, same expression, same pose. Apply comic aesthetics: bold ink outlines, dynamic shading, halftone dots while maintaining perfect likeness.'
        };

        const aiStyleNames = {
            'none': '不套用',
            'anime': '動漫風格',
            'ghibli': '吉卜力',
            'oil-painting': '油畫',
            'watercolor': '水彩畫',
            'sketch': '素描',
            'cyberpunk': '賽博龐克',
            'pixel-art': '像素藝術',
            'pop-art': '普普藝術',
            'impressionist': '印象派',
            '3d-cartoon': '3D 卡通',
            'comic': '美漫風格'
        };

        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const livePreview = document.getElementById('livePreview');
        const shutterBtn = document.getElementById('shutterBtn');
        const flashOverlay = document.getElementById('flashOverlay');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNumber = document.getElementById('countdownNumber');
        const burstIndicator = document.getElementById('burstIndicator');
        const photoDetailsContainer = document.getElementById('photoDetailsContainer');
        const modeDisplay = document.getElementById('modeDisplay');
        const modeIndicator = document.getElementById('modeIndicator');
        const shutterSound = document.getElementById('shutterSound');

        // Frame styles configuration
        const frameClasses = {
            'white': 'frame-white',
            'black': 'frame-black',
            'mint': 'frame-mint',
            'pink': 'frame-pink',
            // 聖誕節
            'christmas': 'frame-christmas',
            'christmas-gold': 'frame-christmas-gold',
            'christmas-snow': 'frame-christmas-snow',
            'christmas-cozy': 'frame-christmas-cozy',
            // 新年
            'newyear': 'frame-newyear',
            'newyear-gold': 'frame-newyear-gold',
            'cny': 'frame-cny',
            'cny-dragon': 'frame-cny-dragon',
            // 生日
            'birthday': 'frame-birthday',
            'birthday-pastel': 'frame-birthday-pastel',
            'birthday-neon': 'frame-birthday-neon',
            'birthday-elegant': 'frame-birthday-elegant',
            // 情人節 & 婚禮
            'valentine': 'frame-valentine',
            'valentine-rose': 'frame-valentine-rose',
            'wedding': 'frame-wedding',
            'wedding-gold': 'frame-wedding-gold',
            // 季節 & 其他
            'vintage': 'frame-vintage',
            'floral': 'pattern-floral',
            'summer': 'frame-summer',
            'autumn': 'frame-autumn',
            'halloween': 'frame-halloween',
            'plaid': 'pattern-plaid',
            'gradient-rainbow': 'frame-gradient-rainbow'
        };

        const filterClasses = {
            'none': 'filter-none',
            'vintage': 'filter-vintage',
            'bw': 'filter-bw',
            'warm': 'filter-warm',
            'cool': 'filter-cool',
            'faded': 'filter-faded',
            'dramatic': 'filter-dramatic',
            'soft': 'filter-soft'
        };

        // === Initialize Camera ===
        async function initCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode },
                    audio: false
                });
                video.srcObject = stream;
                
                // 等待 video 準備好再更新預覽
                video.onloadedmetadata = () => {
                    video.play();
                    updateLivePreview();
                };
            } catch (err) {
                console.error("Camera error:", err);
                alert("無法存取相機，請確認已授予權限。");
            }
        }

        // Live preview with effects
        let animationId = null;
        
        function updateLivePreview() {
            // 取消之前的動畫循環
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            if (!beautyEnabled) {
                video.style.display = 'block';
                livePreview.style.display = 'none';
                video.style.filter = getFilterCSS();
                return;
            }

            video.style.display = 'none';
            livePreview.style.display = 'block';

            const ctx = livePreview.getContext('2d');
            
            function draw() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    if (livePreview.width !== video.videoWidth || livePreview.height !== video.videoHeight) {
                        livePreview.width = video.videoWidth;
                        livePreview.height = video.videoHeight;
                    }
                    
                    ctx.filter = getFilterCSS();
                    ctx.drawImage(video, 0, 0);
                }
                animationId = requestAnimationFrame(draw);
            }
            draw();
        }

        function getFilterCSS() {
            let filter = '';
            filter += `brightness(${brightness}%) `;
            filter += `contrast(${contrast}%) `;
            if (smoothness > 0) filter += `blur(${smoothness}px) `;
            
            // Add selected filter
            switch(currentFilter) {
                case 'vintage': filter += 'sepia(0.4) saturate(0.8)'; break;
                case 'bw': filter += 'grayscale(1)'; break;
                case 'warm': filter += 'sepia(0.2) saturate(1.3)'; break;
                case 'cool': filter += 'hue-rotate(10deg) saturate(0.9)'; break;
                case 'faded': filter += 'saturate(0.8)'; break;
                case 'dramatic': filter += 'contrast(1.3) saturate(1.2)'; break;
                case 'soft': filter += 'blur(0.5px)'; break;
            }
            return filter.trim();
        }

        // === Side Panel Toggle ===
        function toggleSidePanel() {
            const panel = document.getElementById('sidePanel');
            panel.classList.toggle('collapsed');
        }

        // === Tab Navigation ===
        function switchTab(tabId) {
            // 更新水平標籤按鈕
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // 更新垂直標籤按鈕
            document.querySelectorAll('.vtab-btn').forEach(btn => btn.classList.remove('active'));
            // 隱藏所有內容
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 啟用點擊的標籤
            if (event && event.target) {
                const btn = event.target.closest('.tab-btn, .vtab-btn');
                if (btn) btn.classList.add('active');
            }
            
            // 顯示對應內容
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (tabContent) tabContent.classList.add('active');

            // 如果面板是摺疊的，展開它
            const panel = document.getElementById('sidePanel');
            if (panel && panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
            }
        }

        // === Frame Selection ===
        function selectFrame(frame) {
            currentFrame = frame;
            updateOptionButtons(event.target, '#tab-frames');
        }

        // === Filter Selection ===
        function selectFilter(filter) {
            currentFilter = filter;
            updateOptionButtons(event.target, '#tab-filters');
            updateLivePreview();
        }

        // === Camera Settings ===
        function setShootMode(mode) {
            shootMode = mode;
            updateModeDisplay();
            updateOptionButtons(event.target, '#tab-camera .flex-col:first-child');
        }

        function setTimer(seconds) {
            timerSeconds = seconds;
            updateModeDisplay();
            updateOptionButtons(event.target, '#tab-camera .flex-col:last-child');
        }

        function setRatio(ratio) {
            photoRatio = ratio;
            updateOptionButtons(event.target, '#tab-camera');
        }

        function updateModeDisplay() {
            let mode = shootMode.toUpperCase();
            if (timerSeconds > 0) mode += ` + ${timerSeconds}s`;
            modeDisplay.textContent = `MODE: ${mode}`;
            
            let indicator = 'M';
            if (shootMode === 'burst') indicator = '⚡';
            else if (shootMode === 'blur') indicator = '🎨';
            if (timerSeconds > 0) indicator = timerSeconds;
            modeIndicator.textContent = indicator;
        }

        // === Beauty Settings ===
        function toggleBeauty() {
            beautyEnabled = !beautyEnabled;
            document.getElementById('beautyToggle').classList.toggle('active', beautyEnabled);
            updateLivePreview();
        }

        function updateBeauty() {
            brightness = document.getElementById('brightnessSlider').value;
            smoothness = document.getElementById('smoothnessSlider').value;
            exposure = document.getElementById('exposureSlider').value;
            contrast = document.getElementById('contrastSlider').value;

            document.getElementById('brightnessValue').textContent = brightness;
            document.getElementById('smoothnessValue').textContent = smoothness;
            document.getElementById('exposureValue').textContent = exposure;
            document.getElementById('contrastValue').textContent = contrast;

            updateLivePreview();
        }

        // === Toggle Settings ===
        function toggleDate() {
            dateEnabled = !dateEnabled;
            document.getElementById('dateToggle').classList.toggle('active', dateEnabled);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
        }

        function toggleAutoSave() {
            autoSaveEnabled = !autoSaveEnabled;
            document.getElementById('autoSaveToggle').classList.toggle('active', autoSaveEnabled);
        }

        function toggleFlash() {
            flashEnabled = !flashEnabled;
            document.getElementById('flashBtn').style.background = flashEnabled ? '#fbbf24' : 'white';
        }

        function toggleGrid() {
            gridEnabled = !gridEnabled;
            document.getElementById('gridOverlay').style.display = gridEnabled ? 'block' : 'none';
            document.getElementById('gridBtn').style.background = gridEnabled ? '#5a8274' : 'white';
            document.getElementById('gridBtn').style.color = gridEnabled ? 'white' : 'black';
        }

        function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            initCamera();
        }

        // === Sticker Selection ===
        function selectSticker(sticker) {
            selectedSticker = sticker;
            alert(`已選擇貼紙: ${sticker}\n拍照後點擊照片即可添加貼紙！`);
        }

        // === Camera Color ===
        let currentCameraColor = 'mint';
        
        function setCameraColor(color) {
            currentCameraColor = color;
            const cameraBody = document.getElementById('cameraBody');
            
            // Remove all camera color classes
            cameraBody.classList.remove('camera-mint', 'camera-pink', 'camera-blue', 
                'camera-purple', 'camera-yellow', 'camera-white', 'camera-black', 'camera-coral',
                'camera-red', 'camera-caramel', 'camera-forest', 'camera-slate');
            
            // Add new color class
            cameraBody.classList.add(`camera-${color}`);
            
            // Update active button
            document.querySelectorAll('.camera-color-option').forEach(opt => opt.classList.remove('active'));
            if (event && event.target) {
                const option = event.target.closest('.camera-color-option');
                if (option) option.classList.add('active');
            }
            
            // Update title color
            const title = document.querySelector('.instructions');
            const colorMap = {
                'mint': '#5a8274',
                'pink': '#be185d',
                'blue': '#1d4ed8',
                'purple': '#7e22ce',
                'yellow': '#a16207',
                'white': '#4b5563',
                'black': '#6b7280',
                'coral': '#c2410c',
                'red': '#b91c1c',
                'caramel': '#92400e',
                'forest': '#047857',
                'slate': '#334155'
            };
            title.style.color = colorMap[color] || '#5a8274';
        }

        // === Helper Functions ===
        function updateOptionButtons(activeBtn, containerSelector) {
            const container = activeBtn.closest('.tab-content') || document.querySelector(containerSelector);
            if (container) {
                container.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('active'));
            }
            activeBtn.classList.add('active');
        }

        // === Photo Capture ===
        shutterBtn.addEventListener('click', async () => {
            if (!stream) {
                await initCamera();
                return;
            }

            if (timerSeconds > 0) {
                await runCountdown();
            }

            if (shootMode === 'burst') {
                await captureBurst();
            } else {
                capturePhoto();
            }
        });

        async function runCountdown() {
            countdownOverlay.classList.add('active');
            for (let i = timerSeconds; i > 0; i--) {
                countdownNumber.textContent = i;
                countdownNumber.style.animation = 'none';
                void countdownNumber.offsetWidth;
                countdownNumber.style.animation = 'countPulse 1s ease-in-out';
                await new Promise(r => setTimeout(r, 1000));
            }
            countdownOverlay.classList.remove('active');
        }

        async function captureBurst() {
            burstIndicator.classList.add('active');
            for (let i = 1; i <= 4; i++) {
                document.getElementById('burstCount').textContent = i;
                await capturePhoto();
                await new Promise(r => setTimeout(r, 300));
            }
            burstIndicator.classList.remove('active');
        }

        async function capturePhoto() {
            // Play sound
            if (soundEnabled) {
                shutterSound.currentTime = 0;
                shutterSound.play().catch(() => {});
            }

            // Flash effect
            if (flashEnabled) {
                flashOverlay.classList.add('flash-active');
                setTimeout(() => flashOverlay.classList.remove('flash-active'), 300);
            }

            // Capture
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            
            // Apply filters
            ctx.filter = getFilterCSS();
            ctx.drawImage(video, 0, 0);

            // Apply portrait blur effect
            if (shootMode === 'blur') {
                applyPortraitBlur(ctx, canvas.width, canvas.height);
            }

            let dataURL = canvas.toDataURL('image/jpeg', 0.92);
            let originalDataURL = dataURL; // 保存原始照片
            
            // Apply AI Style if selected and connected
            if (currentAIStyle !== 'none' && groqConnected) {
                dataURL = await applyAIStyle(dataURL, currentAIStyle);
            }
            
            // Create scattered photo
            createPhoto(dataURL, originalDataURL);
        }

        function applyPortraitBlur(ctx, width, height) {
            // Simple vignette blur effect (approximation of portrait mode)
            const imageData = ctx.getImageData(0, 0, width, height);
            const centerX = width / 2;
            const centerY = height / 2;
            const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);

            // Create a radial gradient mask for blur
            ctx.save();
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxDist * 0.8);
            gradient.addColorStop(0, 'rgba(0,0,0,0)');
            gradient.addColorStop(0.5, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.3)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            ctx.restore();
        }

        function createPhoto(imgSrc, originalImgSrc = null) {
            photoCount++;
            const photoId = `photo-${photoCount}`;
            const originalSrc = originalImgSrc || imgSrc; // 保存原始照片用於 AI 轉換

            const photoDiv = document.createElement('div');
            photoDiv.id = photoId;
            photoDiv.className = `polaroid-detail pointer-events-auto ${frameClasses[currentFrame]}`;

            // Random position
            const randomAngle = Math.random() * 20 - 10;
            const side = Math.random() > 0.5 ? 1 : -1;
            const randomX = (20 + Math.random() * 25) * side;
            const randomY = Math.random() * 30 - 15;

            photoDiv.style.left = `calc(50% + ${randomX}%)`;
            photoDiv.style.top = `calc(50% + ${randomY}%)`;
            photoDiv.style.transform = `translate(-50%, -50%) rotate(${randomAngle}deg)`;

            // Close button
            const closeBtn = document.createElement('div');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = (e) => { e.stopPropagation(); photoDiv.remove(); };

            // Image area
            const imgArea = document.createElement('div');
            imgArea.className = 'polaroid-image-area';
            if (photoRatio === '4:3') imgArea.classList.add('ratio-4-3');
            if (photoRatio === '16:9') imgArea.classList.add('ratio-16-9');

            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = filterClasses[currentFilter];
            img.style.opacity = '0';
            setTimeout(() => { img.style.opacity = '1'; }, 100);
            imgArea.appendChild(img);

            // Date stamp
            if (dateEnabled) {
                const dateStamp = document.createElement('div');
                dateStamp.className = 'date-stamp';
                const now = new Date();
                dateStamp.textContent = `'${String(now.getFullYear()).slice(2)}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
                imgArea.appendChild(dateStamp);
            }

            // Text input
            const textInput = document.createElement('input');
            textInput.type = 'text';
            textInput.className = 'polaroid-text-input';
            textInput.placeholder = '寫下這一刻...';
            textInput.onclick = (e) => e.stopPropagation();

            // Action buttons
            const actions = document.createElement('div');
            actions.className = 'photo-actions';

            // AI Style button (如果已連線)
            if (groqConnected) {
                const aiBtn = document.createElement('button');
                aiBtn.className = 'action-btn';
                aiBtn.innerHTML = '🤖 AI';
                aiBtn.title = 'AI 風格轉換';
                aiBtn.onclick = async (e) => {
                    e.stopPropagation();
                    await showAIStylePicker(photoDiv, originalSrc);
                };
                actions.appendChild(aiBtn);
            }

            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn';
            editBtn.innerHTML = '✏️ 編輯';
            editBtn.onclick = (e) => { e.stopPropagation(); openEditModal(photoDiv, imgSrc); };

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'action-btn';
            downloadBtn.innerHTML = '💾 下載';
            downloadBtn.onclick = (e) => { 
                e.stopPropagation(); 
                downloadPhoto(photoDiv, photoId);
            };

            actions.appendChild(editBtn);
            actions.appendChild(downloadBtn);

            // Click to add sticker
            imgArea.addEventListener('click', (e) => {
                if (selectedSticker) {
                    const rect = imgArea.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    addStickerToPhoto(imgArea, x, y);
                }
            });

            photoDiv.appendChild(closeBtn);
            photoDiv.appendChild(imgArea);
            photoDiv.appendChild(textInput);
            photoDiv.appendChild(actions);
            photoDetailsContainer.appendChild(photoDiv);

            makeDraggable(photoDiv);

            // Auto save
            if (autoSaveEnabled) {
                setTimeout(() => downloadPhoto(photoDiv, photoId), 500);
            }
        }

        function addStickerToPhoto(container, x, y) {
            const sticker = document.createElement('div');
            sticker.className = 'photo-sticker';
            sticker.textContent = selectedSticker;
            sticker.style.left = `${x}px`;
            sticker.style.top = `${y}px`;
            sticker.onclick = (e) => {
                e.stopPropagation();
                if (confirm('刪除此貼紙?')) sticker.remove();
            };
            container.appendChild(sticker);
            makeStickerDraggable(sticker);
        }

        function makeStickerDraggable(el) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            el.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = el.offsetLeft;
                initialY = el.offsetTop;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                el.style.left = `${initialX + dx}px`;
                el.style.top = `${initialY + dy}px`;
            });

            document.addEventListener('mouseup', () => isDragging = false);
        }

        function downloadPhoto(photoDiv, photoId) {
            const closeBtn = photoDiv.querySelector('.close-btn');
            const actions = photoDiv.querySelector('.photo-actions');
            const textInput = photoDiv.querySelector('.polaroid-text-input');
            
            closeBtn.style.display = 'none';
            actions.style.display = 'none';
            
            // Convert input to text
            if (textInput.value) {
                const textSpan = document.createElement('div');
                textSpan.style.cssText = textInput.style.cssText;
                textSpan.className = textInput.className;
                textSpan.textContent = textInput.value;
                textInput.replaceWith(textSpan);
            }

            html2canvas(photoDiv, {
                backgroundColor: null,
                scale: 3,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `retro-photo-${photoId}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                closeBtn.style.display = 'flex';
                actions.style.display = 'flex';
            });
        }

        // === Edit Modal ===
        function openEditModal(photoDiv, imgSrc) {
            currentEditPhoto = { div: photoDiv, src: imgSrc };
            
            const editCanvas = document.getElementById('editCanvas');
            const drawingCanvas = document.getElementById('drawingCanvas');
            const ctx = editCanvas.getContext('2d');

            const img = new Image();
            img.onload = () => {
                editCanvas.width = img.width;
                editCanvas.height = img.height;
                drawingCanvas.width = img.width;
                drawingCanvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = imgSrc;

            document.getElementById('editModal').classList.add('active');
            setupDrawingCanvas();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditPhoto = null;
            editMode = null;
        }

        function setEditMode(mode) {
            editMode = mode;
            const colorPicker = document.getElementById('editColorPicker');
            colorPicker.style.display = mode === 'draw' ? 'flex' : 'none';

            if (mode === 'text') {
                const text = prompt('請輸入文字:');
                if (text) {
                    addTextToCanvas(text);
                }
            }
        }

        function setupDrawingCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.strokeStyle = drawColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';

            canvas.onmousedown = (e) => {
                if (editMode !== 'draw') return;
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(e.offsetX, e.offsetY);
            };

            canvas.onmousemove = (e) => {
                if (!isDrawing || editMode !== 'draw') return;
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            };

            canvas.onmouseup = () => isDrawing = false;
            canvas.onmouseout = () => isDrawing = false;
        }

        function setDrawColor(color) {
            drawColor = color;
            const ctx = document.getElementById('drawingCanvas').getContext('2d');
            ctx.strokeStyle = color;

            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
            event.target.classList.add('active');
        }

        function addTextToCanvas(text) {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.font = 'bold 48px Caveat';
            ctx.fillStyle = drawColor;
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        }

        function clearDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveEditedPhoto() {
            const editCanvas = document.getElementById('editCanvas');
            const drawingCanvas = document.getElementById('drawingCanvas');
            
            const combinedCanvas = document.createElement('canvas');
            combinedCanvas.width = editCanvas.width;
            combinedCanvas.height = editCanvas.height;
            const ctx = combinedCanvas.getContext('2d');
            
            ctx.drawImage(editCanvas, 0, 0);
            ctx.drawImage(drawingCanvas, 0, 0);

            const newSrc = combinedCanvas.toDataURL('image/jpeg', 0.92);
            
            if (currentEditPhoto) {
                const img = currentEditPhoto.div.querySelector('img');
                img.src = newSrc;
            }

            closeEditModal();
        }

        // === Draggable Photos ===
        function makeDraggable(el) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            const startDrag = (clientX, clientY) => {
                isDragging = true;
                startX = clientX;
                startY = clientY;
                initialX = el.offsetLeft;
                initialY = el.offsetTop;
                el.style.zIndex = 100;
            };

            const doDrag = (clientX, clientY) => {
                if (!isDragging) return;
                const dx = clientX - startX;
                const dy = clientY - startY;
                el.style.transform = 'translate(-50%, -50%) rotate(0deg) scale(1.02)';
                el.style.left = `${initialX + dx}px`;
                el.style.top = `${initialY + dy}px`;
            };

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    const randomAngle = Math.random() * 20 - 10;
                    el.style.transform = `translate(-50%, -50%) rotate(${randomAngle}deg)`;
                    el.style.zIndex = 30;
                }
            };

            el.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                    e.target.classList.contains('close-btn') || e.target.classList.contains('action-btn')) return;
                e.preventDefault();
                startDrag(e.clientX, e.clientY);
            });

            document.addEventListener('mousemove', (e) => doDrag(e.clientX, e.clientY));
            document.addEventListener('mouseup', endDrag);

            el.addEventListener('touchstart', (e) => {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' ||
                    e.target.classList.contains('close-btn') || e.target.classList.contains('action-btn')) return;
                startDrag(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });

            document.addEventListener('touchmove', (e) => {
                if (isDragging) e.preventDefault();
                if (e.touches[0]) doDrag(e.touches[0].clientX, e.touches[0].clientY);
            }, { passive: false });

            document.addEventListener('touchend', endDrag);
        }

        // === Gallery (placeholder) ===
        function openGallery() {
            const photos = document.querySelectorAll('.polaroid-detail');
            if (photos.length === 0) {
                alert('目前沒有照片！開始拍攝吧！');
            } else {
                alert(`目前有 ${photos.length} 張照片在畫面上`);
            }
        }

        // === Groq API Functions ===
        
        // 初始化 API Key 輸入框
        function initGroqAPI() {
            // API Key 不儲存，每次需重新輸入
        }

        // 測試 Groq API 連線
        async function testGroqConnection() {
            const apiKeyInput = document.getElementById('groqApiKey');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                updateApiStatus('disconnected', '請輸入 API Key');
                return;
            }

            if (!apiKey.startsWith('gsk_')) {
                updateApiStatus('disconnected', 'Key 格式錯誤');
                alert('Groq API Key 應以 gsk_ 開頭');
                return;
            }

            updateApiStatus('connecting', '連線中...');

            try {
                // 測試 Groq API 連線
                const response = await fetch('https://api.groq.com/openai/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const visionModels = data.data.filter(m => 
                        m.id.includes('vision') || m.id.includes('llama-4')
                    );
                    
                    groqApiKey = apiKey;
                    groqConnected = true;
                    updateApiStatus('connected', `已連線 ✓ (${visionModels.length} 視覺模型)`);
                    console.log('Groq 可用視覺模型:', visionModels.map(m => m.id));
                } else {
                    const error = await response.json();
                    const errorMsg = error.error?.message || 'API 驗證失敗';
                    throw new Error(errorMsg);
                }
            } catch (error) {
                groqConnected = false;
                updateApiStatus('disconnected', '連線失敗');
                console.error('Groq API Error:', error);
                alert(`API 連線失敗:\n${error.message}\n\n請確認：\n1. API Key 是否正確（gsk_ 開頭）\n2. 是否有足夠的 API 配額`);
            }
        }

        function updateApiStatus(status, text) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = `api-status ${status}`;
            statusEl.querySelector('.status-text').textContent = text;
        }

        // 選擇 AI 風格
        function selectAIStyle(style) {
            currentAIStyle = style;
            
            // 更新按鈕狀態
            document.querySelectorAll('.ai-style-card').forEach(card => {
                card.classList.remove('active');
            });
            if (event && event.target) {
                const card = event.target.closest('.ai-style-card');
                if (card) card.classList.add('active');
            }

            // 如果選擇了 AI 風格但未連線，提醒用戶
            if (style !== 'none' && !groqConnected) {
                alert('請先設定並測試 Groq API 連線！');
            }
        }

        // 使用 Groq + Pollinations 生成 AI 風格圖片
        async function applyAIStyle(imageDataUrl, style) {
            if (style === 'none' || !groqConnected) {
                return imageDataUrl;
            }

            const modal = document.getElementById('aiProcessingModal');
            const statusText = document.getElementById('aiProcessingStatus');
            modal.classList.add('active');

            try {
                // 將 data URL 轉換為 base64
                const base64Data = imageDataUrl.split(',')[1];
                const mimeType = imageDataUrl.split(';')[0].split(':')[1] || 'image/jpeg';
                
                console.log('=== AI Style Start (Groq) ===');
                console.log('MIME:', mimeType, 'Base64長度:', base64Data?.length);

                // 風格關鍵詞
                const styleKeywords = {
                    'anime': 'Japanese anime style, cel-shading, manga illustration',
                    'ghibli': 'Studio Ghibli style, Hayao Miyazaki, soft watercolor',
                    'oil-painting': 'oil painting, brush strokes, Renaissance masterpiece',
                    'watercolor': 'watercolor painting, soft flowing colors',
                    'sketch': 'pencil sketch, graphite drawing, black and white',
                    'cyberpunk': 'cyberpunk style, neon lights, futuristic',
                    'pixel-art': 'pixel art, 16-bit retro game style',
                    'pop-art': 'Andy Warhol pop art, bold colors, Ben-Day dots',
                    'impressionist': 'impressionist painting, Monet style',
                    '3d-cartoon': 'Pixar 3D animation, Disney style, CGI',
                    'comic': 'comic book art, bold ink outlines, Marvel DC style'
                };

                const selectedStyle = styleKeywords[style] || '';

                // Step 1: Groq 圖像分析
                statusText.textContent = '🔍 Groq 分析中...';
                
                let prompt = '';
                let errorMsg = '';
                
                const analysisPrompt = `Please analyze this photo and create a prompt for AI image generation. 

IMPORTANT RULES:
- If the subject is MALE, you MUST use "man" or "male" (never use woman/girl for a male)
- If the subject is FEMALE, you MUST use "woman" or "female"
- Describe the exact age (young, middle-aged, elderly)
- Describe the exact pose, gesture, and expression
- Describe clothing colors and type
- Describe the background

Then add this art style: ${selectedStyle}

Output ONLY the final English prompt as comma-separated keywords, nothing else.`;

                console.log('呼叫 Groq API...');
                
                try {
                    // 使用 Groq Vision API（OpenAI 兼容格式）
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${groqApiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'meta-llama/llama-4-scout-17b-16e-instruct',
                            messages: [
                                {
                                    role: 'user',
                                    content: [
                                        {
                                            type: 'text',
                                            text: analysisPrompt
                                        },
                                        {
                                            type: 'image_url',
                                            image_url: {
                                                url: `data:${mimeType};base64,${base64Data}`
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 500,
                            temperature: 0.3
                        })
                    });

                    console.log('Groq HTTP 狀態:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Groq 回應:', JSON.stringify(result, null, 2));
                        
                        // 提取回應
                        if (result.choices && result.choices[0] && result.choices[0].message) {
                            prompt = result.choices[0].message.content.trim();
                            // 清理引號
                            prompt = prompt.replace(/^["']|["']$/g, '').trim();
                            console.log('Groq 成功:', prompt);
                        } else {
                            errorMsg = 'API 返回的結果無效或為空';
                        }
                    } else {
                        const errData = await response.json().catch(() => ({}));
                        errorMsg = errData.error?.message || `HTTP ${response.status}`;
                        console.error('Groq 錯誤:', errData);
                    }
                } catch (err) {
                    errorMsg = '網路錯誤: ' + err.message;
                    console.error('Groq 異常:', err);
                }

                // ★★★ 顯示結果 ★★★
                if (prompt && prompt.length >= 10) {
                    // 成功
                    statusText.innerHTML = `
                        <div style="text-align:left; padding:10px;">
                            <div style="color:#4ade80; margin-bottom:8px; font-weight:bold;">✅ Groq 分析成功！</div>
                            <div style="background:#1a1a2e; padding:12px; border-radius:8px; font-size:12px; color:#ffd700; word-break:break-all; max-height:150px; overflow-y:auto; border:1px solid #333;">
                                ${prompt}
                            </div>
                            <div style="color:#888; font-size:11px; margin-top:10px;">⏳ 3 秒後開始生成圖像...</div>
                        </div>
                    `;
                } else {
                    // 失敗 - 使用備用
                    prompt = `portrait photo, ${selectedStyle}, high quality, detailed`;
                    statusText.innerHTML = `
                        <div style="text-align:left; padding:10px;">
                            <div style="color:#f87171; margin-bottom:8px; font-weight:bold;">❌ Groq 分析失敗</div>
                            <div style="color:#888; font-size:12px; margin-bottom:8px;">${errorMsg || '未知錯誤'}</div>
                            <div style="color:#60a5fa; font-size:12px;">使用備用提示詞：</div>
                            <div style="background:#1a1a2e; padding:10px; border-radius:8px; font-size:12px; color:#ffd700; margin-top:5px;">
                                ${prompt}
                            </div>
                            <div style="color:#888; font-size:11px; margin-top:10px;">⏳ 3 秒後開始生成圖像...</div>
                        </div>
                    `;
                }
                
                await new Promise(r => setTimeout(r, 3000));

                // Step 2: Pollinations 生成
                statusText.textContent = '🎨 Pollinations 生成中（約 30 秒）...';
                
                const seed = Math.floor(Math.random() * 100000);
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=1024&seed=${seed}&model=flux&nologo=true`;
                
                console.log('Pollinations URL:', url);

                // 載入圖片
                await new Promise((resolve) => {
                    const img = new Image();
                    const timeout = setTimeout(() => { resolve(); }, 60000);
                    img.onload = () => { clearTimeout(timeout); resolve(); };
                    img.onerror = () => { clearTimeout(timeout); resolve(); };
                    img.src = url;
                });

                modal.classList.remove('active');
                return url;

            } catch (error) {
                console.error('Error:', error);
                modal.classList.remove('active');
                return await applyLocalStyleFilter(imageDataUrl, style);
            }
        }

        // 本地 CSS 濾鏡備用方案（增強版）
        function applyLocalStyleFilter(imageDataUrl, style) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');

                    // 根據風格套用不同濾鏡組合
                    const styleEffects = {
                        'anime': () => {
                            ctx.filter = 'contrast(1.3) saturate(1.5) brightness(1.05)';
                            ctx.drawImage(img, 0, 0);
                            // 添加動漫風格的邊緣強調
                            ctx.globalCompositeOperation = 'overlay';
                            ctx.filter = 'blur(0px)';
                            ctx.globalAlpha = 0.3;
                            ctx.drawImage(img, 0, 0);
                            ctx.globalAlpha = 1;
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'ghibli': () => {
                            ctx.filter = 'sepia(0.15) saturate(1.3) brightness(1.1) contrast(0.95)';
                            ctx.drawImage(img, 0, 0);
                            // 添加溫暖的光暈
                            ctx.globalCompositeOperation = 'soft-light';
                            ctx.fillStyle = 'rgba(255, 245, 230, 0.2)';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'oil-painting': () => {
                            ctx.filter = 'contrast(1.2) saturate(1.2)';
                            ctx.drawImage(img, 0, 0);
                            // 模擬油畫質感
                            ctx.globalCompositeOperation = 'overlay';
                            ctx.globalAlpha = 0.15;
                            for (let i = 0; i < 3; i++) {
                                ctx.drawImage(img, Math.random()*2-1, Math.random()*2-1);
                            }
                            ctx.globalAlpha = 1;
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'watercolor': () => {
                            ctx.filter = 'contrast(0.9) brightness(1.15) saturate(1.25)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalCompositeOperation = 'soft-light';
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'sketch': () => {
                            ctx.filter = 'grayscale(1) contrast(1.8) brightness(1.2)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalCompositeOperation = 'color-dodge';
                            ctx.filter = 'invert(1) blur(1px)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'cyberpunk': () => {
                            ctx.filter = 'contrast(1.4) saturate(1.6) hue-rotate(-15deg) brightness(0.95)';
                            ctx.drawImage(img, 0, 0);
                            // 添加霓虹光暈
                            ctx.globalCompositeOperation = 'screen';
                            ctx.globalAlpha = 0.15;
                            ctx.filter = 'blur(10px) hue-rotate(180deg)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalAlpha = 1;
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'pixel-art': () => {
                            // 像素化效果
                            const pixelSize = Math.max(4, Math.floor(img.width / 80));
                            ctx.imageSmoothingEnabled = false;
                            ctx.filter = 'contrast(1.3) saturate(1.4)';
                            ctx.drawImage(img, 0, 0, img.width/pixelSize, img.height/pixelSize);
                            ctx.drawImage(canvas, 0, 0, img.width/pixelSize, img.height/pixelSize, 0, 0, img.width, img.height);
                        },
                        'pop-art': () => {
                            ctx.filter = 'contrast(1.6) saturate(2.2) brightness(1.1)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalCompositeOperation = 'hard-light';
                            ctx.globalAlpha = 0.2;
                            ctx.fillStyle = '#ff00ff';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.globalAlpha = 1;
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'impressionist': () => {
                            ctx.filter = 'contrast(0.95) saturate(1.4) brightness(1.1)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalCompositeOperation = 'soft-light';
                            ctx.fillStyle = 'rgba(255, 200, 150, 0.1)';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        '3d-cartoon': () => {
                            ctx.filter = 'contrast(1.25) saturate(1.35) brightness(1.08)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalCompositeOperation = 'overlay';
                            ctx.globalAlpha = 0.1;
                            ctx.filter = 'blur(2px)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalAlpha = 1;
                            ctx.globalCompositeOperation = 'source-over';
                        },
                        'comic': () => {
                            ctx.filter = 'contrast(1.5) saturate(1.3) brightness(1.05)';
                            ctx.drawImage(img, 0, 0);
                            // 添加半調點效果模擬
                            ctx.globalCompositeOperation = 'multiply';
                            ctx.globalAlpha = 0.1;
                            ctx.filter = 'grayscale(1) contrast(2)';
                            ctx.drawImage(img, 0, 0);
                            ctx.globalAlpha = 1;
                            ctx.globalCompositeOperation = 'source-over';
                        }
                    };

                    // 應用對應的風格效果
                    if (styleEffects[style]) {
                        styleEffects[style]();
                    } else {
                        ctx.drawImage(img, 0, 0);
                    }

                    resolve(canvas.toDataURL('image/jpeg', 0.92));
                };
                img.onerror = () => {
                    resolve(imageDataUrl); // 如果處理失敗，返回原圖
                };
                img.src = imageDataUrl;
            });
        }

        // 為照片添加 AI 風格轉換按鈕
        function addAIStyleButton(photoDiv, originalImgSrc) {
            if (!groqConnected) return;

            const actions = photoDiv.querySelector('.photo-actions');
            const aiBtn = document.createElement('button');
            aiBtn.className = 'action-btn';
            aiBtn.innerHTML = '🤖 AI';
            aiBtn.title = 'AI 風格轉換';
            aiBtn.onclick = async (e) => {
                e.stopPropagation();
                await showAIStylePicker(photoDiv, originalImgSrc);
            };
            actions.insertBefore(aiBtn, actions.firstChild);
        }

        // 顯示 AI 風格選擇器
        async function showAIStylePicker(photoDiv, originalImgSrc) {
            const styleOptions = Object.keys(aiStyleNames)
                .filter(k => k !== 'none')
                .map(k => `${aiStyleNames[k]}`)
                .join('\n');
            
            const choice = prompt(`🎨 選擇 AI 風格轉換 (輸入數字)\n\n✓ 人物臉部、表情、動作將保持一致\n\n1. 動漫風格\n2. 吉卜力\n3. 油畫\n4. 水彩畫\n5. 素描\n6. 賽博龐克\n7. 像素藝術\n8. 普普藝術\n9. 印象派\n10. 3D 卡通\n11. 美漫風格`);
            
            if (!choice) return;

            const styleKeys = ['anime', 'ghibli', 'oil-painting', 'watercolor', 'sketch', 
                             'cyberpunk', 'pixel-art', 'pop-art', 'impressionist', '3d-cartoon', 'comic'];
            const index = parseInt(choice) - 1;
            
            if (index >= 0 && index < styleKeys.length) {
                const newImgSrc = await applyAIStyle(originalImgSrc, styleKeys[index]);
                const img = photoDiv.querySelector('img');
                img.src = newImgSrc;
            }
        }

        // === Feature Tooltip Logic (新增功能介紹氣泡邏輯) ===
        const badge = document.querySelector('.school-badge');
        const tooltip = document.getElementById('featureTooltip');
        const features = [
            "✨ AI 魔法：把照片變成動漫或油畫風格！",
            "🎨 復古濾鏡：一秒拍出懷舊文青感",
            "🖼️ 多樣相框：聖誕、新年、生日主題隨你換",
            "💄 自然美肌：不用化妝也能拍出好氣色",
            "⚡ 連拍模式：捕捉每個精彩瞬間",
            "🌈 創意貼紙：發揮創意裝飾你的拍立得",
            "💾 自動存檔：珍貴回憶不遺失",
            "📱 響應式設計：手機電腦都好用"
        ];

        if (badge && tooltip) {
            badge.addEventListener('mouseenter', () => {
                const randomFeature = features[Math.floor(Math.random() * features.length)];
                tooltip.textContent = randomFeature;
                tooltip.classList.add('active');
            });

            badge.addEventListener('mouseleave', () => {
                tooltip.classList.remove('active');
            });
            
            // 手機版點擊觸發
            badge.addEventListener('touchstart', (e) => {
                e.preventDefault(); // 防止穿透點擊
                const randomFeature = features[Math.floor(Math.random() * features.length)];
                tooltip.textContent = randomFeature;
                tooltip.classList.add('active');
                setTimeout(() => tooltip.classList.remove('active'), 2500);
            });
        }

        // === Initialize ===
        initCamera();
        updateModeDisplay();
        initGroqAPI();
    </script>
</body>
</html>